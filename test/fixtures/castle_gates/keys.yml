# Keys
#
# As we use keys for access rights on groups we need some
# self-referential keys for all groups. If they do not have a
# council their permission gate_bitfield is ~0 - so all true.
# If they do have a council they may not admin the group themselves
# anymore so it is ~4 (:admin being the 3rd bit permission)
#
<%
  group = {
    :view => 1,
    :pester => 2,
    :burden => 3,
    :spy => 4,
    :comment => 5,
    :edit => 6,
    :admin => 7,
    :see_members => 8,
    :see_committees => 9,
    :see_networks => 10,
    :request_membership => 11,
    :join => 12
  }
  user = {
    :view => 1,
    :pester => 2,
    :burden => 3,
    :spy => 4,
    :comment => 5,
    :see_contacts => 6,
    :see_groups => 7,
    :request_contact => 8
  }
  def bitfield(map, *args)
    args.inject(1) {|prior, arg| prior |= (2**map[arg]) }
  end
%>


<% %i(true_levellers animals rainbow warm cold recent_group public_group public_committee private_committee private_group cnt fai fau super_admin_group).each do |name| %>

<%=name%>:
  castle: <%= name %> (Group)
  holder_code: 8<%= identify(name) %>
  gate_bitfield: <%= ~0 %>
<% end %>

animals_for_public:
  castle: animals (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester, :request_membership) %>

rainbow_for_public:
  castle: rainbow (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester) %>

public_group_for_public:
  castle: public_group (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester, :see_committees) %>

public_committee_for_public:
  castle: public_committee (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester, :see_members, :request_membership) %>

cnt_for_public:
  castle: cnt (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester, :request_membership) %>

fai_for_public:
  castle: fai (Group)
  holder_code: 0
  gate_bitfield: <%= bitfield(group, :view, :pester, :request_membership) %>

# TODO: simplify gate_bitfield

groupwithcouncil_for_group:
  castle: groupwithcouncil (Group)
  holder_code: 8<%= identify(:groupwithcouncil) %>
  gate_bitfield: 7999

council_for_council:
  castle: councilofgroupwithcouncil (Group)
  holder_code: 8<%= identify(:councilofgroupwithcouncil) %>
  gate_bitfield: 8191

council_for_group:
  castle: groupwithcouncil (Group)
  holder_code: 8<%= identify(:councilofgroupwithcouncil) %>
  gate_bitfield: 8191

##
## User Keys:
##

<% %i(quentin aaron gerrard blue orange purple yellow red green kangaroo dolphin penguin iguana n00b).each do |login| %>

# friends may view and pester
<%=login%>_friends:
  castle: <%= login %> (User)
  holder_code: 7<%= identify(login) %>
  gate_bitfield: <%= bitfield(user, :view, :pester) %>

# peers may view and pester
<%=login%>_peers:
  castle: <%= login %> (User)
  holder_code: 9<%= identify(login) %>
  gate_bitfield: <%= bitfield(user, :view, :pester) %>

# public may view and pester
<%=login%>_public:
  castle: <%= login %> (User)
  holder_code: 0
  gate_bitfield: <%= bitfield(user, :view, :pester) %>
<% end %>
